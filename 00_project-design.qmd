---
title: Covid-19 comorbidity in Mexico
subtitle: Project for the subject Data Acquistion, Analysis and Scientific Methods in Life Sciences.  
author:
   - affiliation: Instituto Agroforestal Mediterráneo. Departamento de Ecosistemas Agroforestales. Universidad Politécnica de Valencia.
     affiliation-url: https://www.upv.es/entidades/DEAF/
     email: algarsal@upv.es
     name: Alfonso Garmendia
     orcid: 0000-0001-6837-1818
     url: https://garmendia.blogs.upv.es/
title-block-banner: true
date: last-modified
date-format: iso
lang: en-US
code-fold: true
code_folding: hide 
toc: true
toc-depth: 6
toc-location: body
format:
  html:
    self_contained: TRUE
    embed-resources: true
---

# Teacher comments

## Group A

Members:  Cléa Meystre, Neil Mabalot, Sebastian Torres, Raymundo Gutierrez, Hamna Tahir

Github user names: Cmeystre, neilmabalot-34404, torressebastian757-blip, raymoran-netizen, hannatahirskg09-design

Link to data: https://gaia.inegi.org.mx/covid19/

## The project design

The project is right.  It is interesting to link Covid with social or health data. 

But in the link you provide, there are only covid data. I didn’t find the other health data. 

There are covid19 data also in R packages, as the “COVID19” package from John Hopkins University, which enables also to download data from the World Bank and other sources. You should also explore these. 

Other problem is that you will not have a nice article to follow. It might be interesting to look for an article for the proposed comorbidities. 

For example Salinas-Aguirre et al. (2021) Clinical characteristics and comorbidities associated with mortality in patients with Covid-19 in Coalhuila (Mexico). 

You can start with your project (check the task "Your project. Preliminary results" in PoliformaT). 

# Students proposal

Quarto enables you to weave together content and executable code into a finished document. To learn more about Quarto see <https://quarto.org>.

1.  Title of your project (in Yaml header)

2.  Names of group members (in Yaml header).

3.  Github user name for each group member.

    Githib user name: Cmeystre, neilmabalot-34404, torressebastian757-blip, raymoran-netizen, hannatahirskg09-design

#4.  A description of the selected data. A link to the data and describe its structure and main variables. (If it is your own data, upload it to github to link it here).

    Description: This dataset was created as a report of the COVID-19 pandemic in Mexico. Starting in March 2020 to September 2023. The virus infected and in some cases killed people all over the country. However we theorize that those deaths were affected through other comorbidities present before the infection. We propose to find a corelation between comorbidities such as diabetes, hypertension, smoking and heart diseases and death rates caused by COVID19. The proposal analyzes will be carried out with a lineal regression model.

#5.  Define the objectives, research questions and main hypotheses.

    Objective: Determine if the COVID-19 mortality rates are directly linked to contracting the COVID-19 virus or if they are due to the individual being simultaneously infected with COVID-19 and a comorbidity disease(s).

    Research question: What is the correlation between the presence of comorbidities and the mortality rate of COVID-19 patients?

    Main Hypothesis: There is a higher risk of death with a combination of COVID-19 and a comorbidity disease(s).

#6.  Name the analyses you think are necessary or which you would like to use.

    1.Linear regression model - To see the correlation between our different factors (Mortality rates, contraction of COVID-19 virus and the presence of comorbidities diseases).

    2.Test for Moderation - To see how the comorbidities impacts COVID-19 deaths.

    3\. ANOVA - To see if there is a statistical difference between mean deaths per age group.

    4.Post-hoc tests ANOVA (Tukey test) - Used to see the statistical differences and attempt to explain their correlation to mortality rates.
    
    Data Link: https://gaia.inegi.org.mx/covid19/
    
    Sources: https://journals.plos.org/plosone/article?id=10.1371/journal.pone.0296895
             https://www.sciencedirect.com/science/article/pii/S0014256521000138
             
#7.   Introduction. Why your project is interesting? and What is known already about it? Most citations should  be done in the introduction.
  Our project is interesting because it regards a worldwide pandemic that impacted many countries drastically. We will study the correlation between presence of 4 different comorbities and their impact on COVID-19 Deaths. 

#8. Objectives and hypotheses.
 Objectives: Reach an understanding at how comorbidities affect the patients and can possibly increase mortality. We also aimed to understand what specific comorbidity or combination of two comorbities out of the four present in the data set, are most impactful in this study. 
  Final hypotheses: 

#9. Methods. Explain the origin and structure of your data. What have you done? And what did you use to do it? Step by step, so anyone could do it again by reading this part.
  1. Chi square Test - The Chi square test is gonna allow us to find association between DEATHS & each COMORBIDITY. All tests resulted in highly significant p-values, indicating that the distribution of deaths differs significantly between patients with and without the comorbidity. This supports the conclusion that comorbidities are strongly associated with increased mortality. Now that we found statistically significant association between each and every comorbidity, to investigate about the probability of death based on the presence or absence of each comorbidity, combinations & interactions. The logistic model is ideal for this analysis because our outcome variables are binary.
  
  2. Logistic Regressions - We first ran individual LRM to measure the association of each individual Comorbidity. Then to isolate the effect we incorporated all the Comorbidities analyzed in this study as a Multivariable Model (MVM). This model is considering the whole dataset. Answering the question: Across the entire population, does each comorbidity increase the odds of dying? 
  We then made another version of the MVM that would only consider the people with at least 1 comorbility (a subset of the data (Number of CM >=1)) that would attenuate the effect of the Comorbitiy (MVMwithCM). Answering the question: Among people who already have comorbidities, which specific diseases increase the odds of death? 
  We then compared the MVM and the MVMwithCM models with a mortality baseline given by a LRM of only the people WITH OUT any CM (LRMnoCM).
  Another interesting question to analyse would be if the addition of multiple Comorbities increases the odds of death.To answer this question we run a LGM considering Number_of_Comorbidities (given in our dataset) (LRM_NCM).
  Now that we know that the risk of death increases as the Number of Comorbidities increases. Identifying which combination of Comorbidities is the most dangerous would help us shape the profile for a high risk of death infected person, given that usually Comorbidities appear simultaneously. To analyse this we used the Paired LRM (PLRM) and used it to compare Diabetes + Hypertension, Diabetes + Smoking, Diabetes + Obesity, Hypertension + Smoking, Obesity + Smoking and Hypertension + Obesity. 
  Finally, we created a single combined output table with the Individual LRM results for each Comorbidity and the PLRM results. 
  
  3. AIV and GIV analyses - Incremental value analysis was used to quantify the relative importance of four predictors—hypertension, obesity, diabetes, and smoking—across multiple logistic regression specifications.
Average Incremental Value (AIV) was computed for each predictor as the mean absolute standardized coefficient (|β/SE|) across all models in which the predictor appeared. AIV reflects the average individual contribution of a predictor to model performance, regardless of other covariates.
General Incremental Value (GIV) was calculated as the sum of AIV contributions across all model combinations involving each predictor. GIV reflects the overall importance of each variable across the entire model space, capturing how consistently and strongly it improves predictive performance.
Both metrics provide a complementary assessment: AIV reflects effect strength within models, while GIV reflects global contribution across models. Higher values for either metric indicate stronger incremental predictive importance.
  4. ANOVA - 

10. Results. Figures and tables with captions and description of what do they mean. Never include citations in this part. This is only your work.

11. Discussion. From your objectives.

12. Conclusions.

##----------------- Load the data base-------------------------------
```{r}
dir("data")
data <- "data/covid_mexico_comorbidity_dataset_100k.csv"
covid19A <- read.table(data, header = T, sep = ",")
str (covid19A) 
summary(covid19A)

library(dplyr)
```

### ------------------Chi square Test--------------------------------
# The Chi square test is gonna allow us to find association between Deaths & each Comorbidities
```{r}
comorbidities <- c("Diabetes", "Hypertension", "Obesity", "Smoking")

for (c in comorbidities) {
  cat("\n==========================\n")
  cat("Chi-square test for", c, "\n")
  tab <- table(covid19A$COVID_Death, covid19A[[c]])
  print(tab)
  print(chisq.test(tab))
}
```

# results table
```{r}
chi_results <- data.frame(
  Comorbidity = character(),
  Chi_square = numeric(),
  df = numeric(),
  P_value = numeric()
)

for (c in comorbidities) {
  tab <- table(covid19A$COVID_Death, covid19A[[c]])
  chi <- chisq.test(tab)
  
  chi_results <- rbind(
    chi_results,
    data.frame(
      Comorbidity = c,
      Chi_square = chi$statistic,
      df = chi$parameter,
      P_value = chi$p.value
    )
  )
}
chi_results
```

###-------------LOGISTIC REGRESION MODEL (LRM)-------------------------
# We start doing individual LRM for each Comorbidity
```{r}
## load library 
library(broom)

# Indiv. LRM Diabetes

model_Diabetes <- glm(
  COVID_Death ~ Diabetes,
  data = covid19A,
  family = binomial()
)
summary(model_Diabetes)
tidy(model_Diabetes, exponentiate = TRUE, conf.int = TRUE)

# Indiv. LRM Smoking

model_Smoking <- glm(
  COVID_Death ~ Smoking,
  data = covid19A,
  family = binomial()
)
summary(model_Smoking)
tidy(model_Smoking, exponentiate = TRUE, conf.int = TRUE)

# Indiv. LRM  Obesity

model_Obesity <- glm(
  COVID_Death ~ Obesity,
  data = covid19A,
  family = binomial()
)
summary(model_Obesity)
tidy(model_Obesity, exponentiate = TRUE, conf.int = TRUE)

# Indiv. LRM  Hypertension

model_Hypertension <- glm(
  COVID_Death ~ Hypertension,
  data = covid19A,
  family = binomial()
)
summary(model_Hypertension)
tidy(model_Hypertension, exponentiate = TRUE, conf.int = TRUE)

##Multivariable Model (MVM)

MVM <- glm(COVID_Death ~ Diabetes + Hypertension + Obesity + Smoking,
                  data = covid19A,
                  family = binomial)
summary(MVM)

#MVM with CM

with_comorb <- subset(covid19A, Number_of_Comorbidities > 0)

MVMwithCM <- glm(COVID_Death ~ Diabetes + Hypertension + Obesity + Smoking,
                  data = with_comorb,
                  family = binomial)
summary(MVMwithCM)

#Mortality baseline (Deaths WITH OUT CM)

no_comorb <- subset(covid19A, Number_of_Comorbidities == 0)

LRMnoCM <- glm(COVID_Death ~ 1,        
                data = no_comorb,
                family = binomial)
summary(LRMnoCM)

#LGM Number of comorbidities

LRM_NCM <- glm(COVID_Death ~ Number_of_Comorbidities,
                 data = with_comorb, #again with the subset 
                 family = binomial)
summary(LRM_NCM)
```

#Paired Logistic Regression Models (PLRM) and the comparisons. 
```{r}
# Logistic Regression 1: Diabetes + Hypertension
model_Diabetes_Hypertension <- glm(
  COVID_Death ~ Diabetes + Hypertension,
  data = covid19A,
  family = binomial()
)
summary(model_Diabetes_Hypertension)
tidy(model_Diabetes_Hypertension, exponentiate = TRUE, conf.int = TRUE)

# Logistic Regression 2: Diabetes + Smoking
model_Diabetes_Smoking <- glm(
  COVID_Death ~ Diabetes + Smoking,
  data = covid19A,
  family = binomial()
)
summary(model_Diabetes_Smoking)
tidy(model_Diabetes_Smoking, exponentiate = TRUE, conf.int = TRUE)

# Logistic Regression 3: Diabetes + Obesity
model_Diabetes_Obesity <- glm(
  COVID_Death ~ Diabetes + Obesity,
  data = covid19A,
  family = binomial()
)
summary(model_Diabetes_Obesity)
tidy(model_Diabetes_Obesity, exponentiate = TRUE, conf.int = TRUE)

# Logistic Regression 4: Hypertension + Smoking
model_Hypertension_Smoking <- glm(
  COVID_Death ~ Hypertension + Smoking,
  data = covid19A,
  family = binomial()
)
summary(model_Hypertension_Smoking)
tidy(model_Hypertension_Smoking, exponentiate = TRUE, conf.int = TRUE)

# Logistic Regression 5: Obesity + Smoking
model_Obesity_Smoking <- glm(
  COVID_Death ~ Obesity + Smoking,
  data = covid19A,
  family = binomial()
)
summary(model_Obesity_Smoking)
tidy(model_Obesity_Smoking, exponentiate = TRUE, conf.int = TRUE)

# Logistic Regression 6: Hypertension + Obesity
model_Hypertension_Obesity <- glm(
  COVID_Death ~ Hypertension + Obesity,
  data = covid19A,
  family = binomial()
)
summary(model_Hypertension_Obesity)
tidy(model_Hypertension_Obesity, exponentiate = TRUE, conf.int = TRUE)
```

#Single combined output table of all 10 Logistic Regression Models 
```{r}
models <- list(
  Diabetes_Hypertension = model_Diabetes_Hypertension,
  Diabetes_Smoking = model_Diabetes_Smoking,
  Diabetes_Obesity = model_Diabetes_Obesity,
  Hypertension_Smoking = model_Hypertension_Smoking,
  Obesity_Smoking = model_Obesity_Smoking,
  Hypertension_Obesity = model_Hypertension_Obesity,
  Hypertension = model_Hypertension,
  Obesity = model_Obesity,
  Smoking = model_Smoking,
  Diabetes = model_Diabetes
)
results <- lapply(names(models), function(name) {
  tidy(models[[name]], exponentiate = TRUE, conf.int = TRUE) %>%
    mutate(Model = name)
})
combined_results <- bind_rows(results)
combined_results
```

